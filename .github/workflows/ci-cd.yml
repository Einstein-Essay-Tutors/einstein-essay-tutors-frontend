name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Run type checking
      run: npm run type-check
      
    - name: Run tests
      run: npm test
      continue-on-error: true
      
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: http://localhost:8000

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://35.83.66.24' }}
    
    - name: Create deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy-package
        
        # Copy built application
        cp -r .next/standalone/* deploy-package/
        
        # Copy static assets
        cp -r .next/static deploy-package/.next/
        cp -r public deploy-package/
        
        # Copy configuration files
        cp ecosystem.config.js deploy-package/
        cp deploy.sh deploy-package/
        cp package.json deploy-package/
        
        # Create archive
        tar -czf frontend-build.tar.gz -C deploy-package .
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend-build.tar.gz
        retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
    
    - name: Deploy to production server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "frontend-build.tar.gz"
        target: "/tmp/"
    
    - name: Execute deployment on server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # Set deployment variables
          PROJECT_DIR="/home/ubuntu/essay-writing-tutors/einstein-essay-tutors-frontend"
          APP_NAME="einstein-essay-tutors-frontend"
          BUILD_ARCHIVE="/tmp/frontend-build.tar.gz"
          
          # Create project directory structure if it doesn't exist
          sudo mkdir -p "$PROJECT_DIR"
          sudo chown -R ubuntu:ubuntu /home/ubuntu/essay-writing-tutors
          
          # Clone or update repository for configs
          if [ -d "$PROJECT_DIR/.git" ]; then
            echo "Repository exists, pulling latest changes..."
            cd "$PROJECT_DIR"
            git pull origin main
          else
            echo "Cloning repository..."
            git clone https://github.com/ewt-writers/einstein-essay-tutors-frontend.git "$PROJECT_DIR"
            cd "$PROJECT_DIR"
          fi
          
          # Stop the current PM2 process
          pm2 stop "$APP_NAME" 2>/dev/null || echo "Process not currently running"
          
          # Backup current build (if exists)
          if [ -d ".next" ]; then
            rm -rf .next.backup 2>/dev/null || true
            mv .next .next.backup 2>/dev/null || true
          fi
          
          # Extract new build
          tar -xzf "$BUILD_ARCHIVE" -C "$PROJECT_DIR"
          
          # Set proper permissions
          chmod +x deploy.sh 2>/dev/null || true
          
          # Create logs directory
          sudo mkdir -p /home/ubuntu/logs
          sudo chown ubuntu:ubuntu /home/ubuntu/logs
          
          # Start the application with PM2
          pm2 start ecosystem.config.js
          
          # Save PM2 configuration
          pm2 save
          
          # Wait for application to start
          sleep 10
          
          # Health check
          if curl -f http://localhost:3000/ > /dev/null 2>&1; then
            echo "âœ… Frontend deployment successful!"
            # Remove backup on success
            rm -rf .next.backup 2>/dev/null || true
          else
            echo "âŒ Frontend health check failed!"
            # Rollback on failure
            if [ -d ".next.backup" ]; then
              echo "ðŸ”„ Rolling back to previous version..."
              rm -rf .next 2>/dev/null || true
              mv .next.backup .next
              pm2 restart "$APP_NAME"
              sleep 5
              curl -f http://localhost:3000/ && echo "Rollback successful" || echo "Rollback failed"
            fi
            exit 1
          fi
          
          # Reload nginx
          sudo systemctl reload nginx
          
          # Clean up
          rm -f "$BUILD_ARCHIVE"
          
          # Show final status
          pm2 list
          echo "ðŸŽ‰ Frontend deployment completed successfully!"